<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Java程序从Hadoop 2迁移到3 - atttx123的blog</title><meta name=description content="Java程序从Hadoop 2迁移到3需要注意的事项，有哪些坑?"><meta name=author content="atttx123"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"atttx123的blog","url":"http:\/\/blog.atttx123.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"http:\/\/blog.atttx123.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"http:\/\/blog.atttx123.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"http:\/\/blog.atttx123.cn\/posts\/2019-12-25-java-project-from-hadoop2-to-3\/","name":"Java程序从 hadoop 2迁移到3"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"atttx123"},"headline":"Java程序从Hadoop 2迁移到3","description":" Java程序从Hadoop 2迁移到3需要注意的事项，有哪些坑?\n","inLanguage":"zh-cn","wordCount":196,"datePublished":"2019-12-25T20:46:21","dateModified":"2019-12-25T20:46:21","image":"http:\/\/blog.atttx123.cn\/img\/avatar-icon.png","keywords":[""],"mainEntityOfPage":"http:\/\/blog.atttx123.cn\/posts\/2019-12-25-java-project-from-hadoop2-to-3\/","publisher":{"@type":"Organization","name":"http:\/\/blog.atttx123.cn\/","logo":{"@type":"ImageObject","url":"http:\/\/blog.atttx123.cn\/img\/avatar-icon.png","height":60,"width":60}}}</script><meta property="og:title" content="Java程序从Hadoop 2迁移到3"><meta property="og:description" content="Java程序从Hadoop 2迁移到3需要注意的事项，有哪些坑?"><meta property="og:image" content="http://blog.atttx123.cn/img/avatar-icon.png"><meta property="og:url" content="http://blog.atttx123.cn/posts/2019-12-25-java-project-from-hadoop2-to-3/"><meta property="og:type" content="website"><meta property="og:site_name" content="atttx123的blog"><meta name=twitter:title content="Java程序从Hadoop 2迁移到3"><meta name=twitter:description content="Java程序从Hadoop 2迁移到3需要注意的事项，有哪些坑?"><meta name=twitter:image content="http://blog.atttx123.cn/img/avatar-icon.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@atttx123"><meta name=twitter:creator content="@atttx123"><link href=http://blog.atttx123.cn/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.62.0"><link rel=alternate href=http://blog.atttx123.cn/index.xml type=application/rss+xml title=atttx123的blog><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=http://blog.atttx123.cn/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=http://blog.atttx123.cn/css/syntax.css><link rel=stylesheet href=http://blog.atttx123.cn/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>切换导航</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=http://blog.atttx123.cn/>atttx123的blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a href=/en lang=en>en</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=atttx123的blog href=http://blog.atttx123.cn/><img class=avatar-img src=http://blog.atttx123.cn/img/avatar-icon.png alt=atttx123的blog></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Java程序从Hadoop 2迁移到3</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><blockquote><p>Java程序从Hadoop 2迁移到3需要注意的事项，有哪些坑?</p></blockquote><h2 id=hadoop-3->Hadoop 3 版本介绍</h2><hr><p>hadoop 3 的第一个版本是2017年12月8日GA的，主要版本及发布时间如下：</p><table><thead><tr><th>版本</th><th>时间</th></tr></thead><tbody><tr><td>r3.2.1</td><td>2019-09-24</td></tr><tr><td>r3.2.0</td><td>2019-01-08</td></tr><tr><td>r3.1.3</td><td>2019-09-12</td></tr><tr><td>r3.1.2</td><td>2019-01-29</td></tr><tr><td>r3.1.1</td><td>2018-08-02</td></tr><tr><td>r3.1.0</td><td>2018-03-30</td></tr><tr><td>r3.0.3</td><td>2018-05-31</td></tr><tr><td>r3.0.2</td><td>2018-04-13</td></tr><tr><td>r3.0.1</td><td>2018-03-16</td></tr><tr><td>r3.0.0</td><td>2017-12-08</td></tr></tbody></table><h2 id=hadoop-23>Hadoop 2与3有哪些不同</h2><hr><p>Hadoop 3 在 Hadoop 2的基础上进行了大量的更新，从官方文档中整理出以下几个大方面<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>：</p><h3 id=common>Common主要改进</h3><ul><li>重写了shell管理脚本</li><li>过时API删除</li><li>客户端拆分成hadoop-client-api和hadoop-client-runtime，避免依赖包冲突</li></ul><h3 id=hdfs>HDFS改进</h3><ul><li>支持erasure编码</li><li>支持超过两个namenode</li><li>多个服务默认端口发生变化（影响NameNode, Secondary NameNode, DataNode, KMS）</li></ul><h3 id=yarn>Yarn改进</h3><ul><li>新版本YARN Timeline Service</li><li>支持Cgroup和docker</li></ul><h3 id=maprduece>MapRduece改进</h3><ul><li>任务原生优化</li><li>更加简易的内存配置</li></ul><h2 id=heading>终端用户关心的主要变化</h2><hr><p>以上更新中，终端用户比较关心的变化有以下两个：</p><h3 id=heading-1>默认端口发生变化</h3><p>主要是HDFS和KMS的部分端口发生了变化，具体的更新是这两个issue：<a href=https://issues.apache.org/jira/browse/HDFS-9427>HDFS-9427</a>（HDFS部分）和<a href=https://issues.apache.org/jira/browse/HADOOP-12811>HADOOP-12811</a>（KMS部分）</p><p>HDFS端口变化如下：</p><table><thead><tr><th>组件</th><th>服务</th><th>协议</th><th>端口 (2 &ndash;> 3)</th><th>配置</th><th>备注</th></tr></thead><tbody><tr><td>HDFS</td><td>NameNode</td><td>HTTP</td><td>50070 &ndash;> 9870</td><td><code>dfs.namenode.http-address</code></td><td>WebUI，一般是集群管理员或运维人员访问</td></tr><tr><td>HDFS</td><td>NameNode</td><td>HTTPS</td><td>50470 &ndash;> 9871</td><td><code>dfs.namenode-https-address</code></td><td>WebUI，一般是集群管理员或运维人员访问</td></tr><tr><td>HDFS</td><td>NameNode</td><td>IPC</td><td>8020 &ndash;> 9820</td><td><code>fs.defaultFS</code></td><td>交换metadata，所有的数据请求都需要访问</td></tr><tr><td>HDFS</td><td>NameNode</td><td>TPC</td><td>默认没有配置（CDH推荐使用8022）</td><td><code>dfs.namenode. servicerpc-address</code></td><td>如果配置了，HDFS内部服务会通过这个地址交换信息，避免和client抢占 <code>fs.defaultFS</code></td></tr><tr><td>HDFS</td><td>Secondary NameNode</td><td>HTTP</td><td>50090 &ndash;> 9868</td><td><code>dfs.namenode.secondary.http-address</code></td><td>Checkpoin for NameNode metadata</td></tr><tr><td>HDFS</td><td>Secondary NameNode</td><td>HTTPS</td><td>50091 &ndash;> 9869</td><td><code>dfs.namenode.secondary.https-address</code></td><td></td></tr><tr><td>HDFS</td><td>DataNode</td><td>TPC</td><td>50010 &ndash;> 9866</td><td><code>dfs.datanode.address</code></td><td>数据交换</td></tr><tr><td>HDFS</td><td>DataNode</td><td>IPC</td><td>50020 &ndash;> 9867</td><td><code>dfs.datanode.ipc.address</code></td><td>Metadata operations</td></tr><tr><td>HDFS</td><td>DataNode</td><td>HTTP</td><td>50075 &ndash;> 9864</td><td><code>dfs.datanode.http.address</code></td><td>WebUI</td></tr><tr><td>HDFS</td><td>DataNode</td><td>HTTPS</td><td>50475 &ndash;> 9865</td><td><code>dfs.datanode.https.address</code></td><td>WebUI</td></tr></tbody></table><h3 id=java-client>Java Client拆分</h3><p>在Hadoop 2中常用的client包有以下几种：</p><ul><li>HDFS：<ul><li><a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-common>hadoop-common</a>包：提供<code>UserGroupInformation</code>、<code>Configuration</code>等基本类以及<code>FileSystem</code>这个抽象接口类</li><li><a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-hdfs-client>hadoop-hdfs-client</a>：提供<code>DistributedFileSystem</code>这个具体实现以及<code>DFSClient</code>等与HDFS通信的工具类</li></ul></li><li>Yarn<ul><li><a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-yarn-client>hadoop-yarn-client</a>：提供<code>YarnClient</code>（与Yarn通信的工具类）</li></ul></li></ul><p>不过Hadoop 2提供的包有以下几个问题：</p><ol><li>抽象层不统一：比如<a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-common>hadoop-common</a>包内有<code>FTPFileSystem</code>、<code>HTTPFileSystem</code>等具体实现</li><li>包依赖过多容易发生冲突：比如<a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-common>hadoop-common</a>包依赖Guava、log4j等库<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li></ol><h4 id=heading-2>拆分的新包</h4><p>基于以上问题，在Hadoop 3中有了新的两个包：</p><ul><li><a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-client-api>hadoop-client-api</a>：提供接口定义</li><li><a href=https://search.maven.org/artifact/org.apache.hadoop/hadoop-client-runtime>hadoop-client-runtime</a>：提供具体实现</li></ul><p>新包的依赖结构比之前版本简单很多，具体依赖如下：</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>+- org.apache.hadoop:hadoop-client-api:jar:3.2.1:compile
\- org.apache.hadoop:hadoop-client-runtime:jar:3.2.1:runtime
   +- org.apache.htrace:htrace-core4:jar:4.1.0-incubating:runtime
   +- org.slf4j:slf4j-api:jar:1.7.25:runtime
   +- commons-logging:commons-logging:jar:1.1.3:runtime
   \- com.google.code.findbugs:jsr305:jar:3.0.0:runtime
</code></pre></div><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://hadoop.apache.org/docs/r3.0.0/index.html>Hadoop 3.0 Release Note</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=/html/hadoop-client-dependencies-2vs-3.html>hadoop client 2.7.4和3.2.1依赖对比</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article><ul class="pager blog-pager"></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:atttx123@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/atttx123 title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/atttx123 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/atttx123 title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">atttx123
&nbsp;&bull;&nbsp;&copy;
2019
&nbsp;&bull;&nbsp;
<a href=http://blog.atttx123.cn/>atttx123的blog</a></p><p class="credits theme-by text-muted">由 <a href=https://gohugo.io>Hugo v0.62.0</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=http://blog.atttx123.cn/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=http://blog.atttx123.cn/js/load-photoswipe.js></script></body></html>